apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-fluentbit-to-fluentd
  namespace: efkstack # Fluentd가 있는 네임스페이스
spec:
  # 이 정책은 fluentd-aggregator 레이블을 가진 파드에 적용됩니다.
  podSelector:
    matchLabels:
      app: fluentd-aggregator
  policyTypes:
  - Ingress
  # Ingress (들어오는 트래픽) 규칙
  ingress:
  # 아래 조건을 만족하는 트래픽을 허용합니다.
  - from:
    # 1. efkstack 네임스페이스 내부의 모든 파드
    - podSelector: {}
    # 2. (선택적) 다른 네임스페이스의 fluent-bit를 위해 추가
    - namespaceSelector:
        matchLabels:
          # 모든 네임스페이스에서 들어오는 것을 허용하려면,
          # 각 네임스페이스에 특별한 레이블을 추가하고 여기에 명시하거나,
          # 더 간단하게는 from 필드를 비워두어 모든 소스를 허용할 수 있습니다.
          # 여기서는 우선 같은 네임스페이스 내 통신을 보장합니다.
          kubernetes.io/metadata.name: efkstack
    ports:
    # fluentd의 24224 포트로 들어오는 TCP 트래픽을 허용합니다.
    - protocol: TCP
      port: 24224